<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prototipo – ReportConverter Casos de Uso</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- SheetJS para parseo de Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .navbar-brand { font-weight: 600; }
    .tab-btn.active { background-color: #0d6efd; color: #fff; }
    .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 1080; }
    #excelPreview { max-height: 200px; overflow: auto; margin-top: .5rem;
                    background: #fff; border: 1px solid #dee2e6; padding: .5rem; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ReportConverter</a>
      <div class="d-flex gap-2">
        <button id="tabReports" class="btn btn-outline-light tab-btn active">Reportes</button>
        <button id="tabImport" class="btn btn-outline-light tab-btn">Importar Excel</button>
        <button id="tabUsers" class="btn btn-outline-light tab-btn">Usuarios</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <!-- Sección Listado de reportes -->
    <section id="reportsSection">
      <h2 class="mb-3">Listado de reportes</h2>
      <div class="mb-3 d-flex gap-2">
        <input id="searchReports" type="search" class="form-control" placeholder="Buscar reporte..." style="max-width:300px"/>
        <button class="btn btn-secondary" onclick="renderReports()">Limpiar</button>
      </div>
      <div class="table-responsive">
        <table id="reportsTable" class="table table-striped align-middle"></table>
      </div>
    </section>

    <!-- Sección Importar y parsear Excel -->
    <section id="excelSection" class="d-none">
      <h2 class="mb-3">Importar y parsear Excel</h2>
      <input id="excelInput" type="file" accept=".xlsx,.xls" class="form-control w-50 mb-2" />
      <div id="excelPreview"></div>
    </section>

    <!-- Sección Gestión de usuarios -->
    <section id="usersSection" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Gestión de usuarios</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" onclick="openUserModal()">+ Nuevo usuario</button>
      </div>
      <div class="table-responsive">
        <table id="usersTable" class="table table-striped align-middle"></table>
      </div>
    </section>
  </div>

  <!-- Transform Report Modal -->
  <div class="modal fade" id="transformModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="transformForm" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Transformar reporte</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Formato destino</label>
              <select id="formatSelect" class="form-select" required>
                <option value="">Elegir formato</option>
                <option value="CSV">CSV</option>
                <option value="XLSX">XLSX</option>
                <option value="PDF">PDF</option>
              </select>
              <div class="invalid-feedback">Seleccione un formato válido.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Filtro fecha mayor a</label>
              <input id="dateFilter" type="date" class="form-control" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Transformar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="userForm" class="needs-validation" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Nuevo usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input id="userEmail" type="email" class="form-control" required />
              <div class="invalid-feedback">Email requerido.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Contraseña</label>
              <input id="userPassword" type="password" class="form-control" minlength="6" required />
              <div class="invalid-feedback">Contraseña mínima 6 caracteres.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Rol</label>
              <select id="userRole" class="form-select" required>
                <option value="">Elija rol</option>
                <option value="admin">Admin</option>
                <option value="analista">Analista</option>
              </select>
              <div class="invalid-feedback">Rol requerido.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container"></div>

  <!-- Bootstrap JS + Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Datos de ejemplo
    let reports = [
      { id:1, nombre:'Ventas Q2', fecha:'2025-06-01', formato:'CSV', estado:'Disponible' },
      { id:2, nombre:'Inventario', fecha:'2025-05-20', formato:'XLSX', estado:'Disponible' }
    ];
    let users = [
      { id:1, email:'admin@empresa.com', rol:'admin', activo:true },
      { id:2, email:'ana@empresa.com', rol:'analista', activo:true }
    ];

    // Helpers: Toast
    const toastContainer = document.querySelector('.toast-container');
    function showToast(msg, ok=true){
      const t = document.createElement('div');
      t.className = `toast align-items-center text-bg-${ok?'success':'danger'} border-0`;
      t.role = 'alert';
      t.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${msg}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      toastContainer.appendChild(t);
      const bs = new bootstrap.Toast(t,{delay:3000});
      bs.show();
      t.addEventListener('hidden.bs.toast',()=>t.remove());
    }

    // Render reportes
    const reportsTable = document.getElementById('reportsTable');
    function renderReports(filter=''){
      const filas = reports
        .filter(r=>r.nombre.toLowerCase().includes(filter.toLowerCase()))
        .map(r=>`
          <tr>
            <td>${r.nombre}</td><td>${r.fecha}</td><td>${r.formato}</td><td>${r.estado}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-primary me-1" onclick="openTransformModal(${r.id})">Transformar</button>
              <button class="btn btn-sm btn-danger" onclick="deleteReport(${r.id})">Eliminar</button>
            </td>
          </tr>`);
      reportsTable.innerHTML = `
        <thead>
          <tr><th>Nombre</th><th>Fecha</th><th>Formato</th><th>Estado</th><th></th></tr>
        </thead>
        <tbody>
          ${filas.join('')||'<tr><td colspan="5" class="text-center">Sin resultados</td></tr>'}
        </tbody>`;
    }

    // Transform modal
    let selectedReportId=null;
    const transformModal = new bootstrap.Modal('#transformModal');
    const transformForm  = document.getElementById('transformForm');
    function openTransformModal(id){
      selectedReportId=id;
      transformForm.reset();
      transformForm.classList.remove('was-validated');
      transformModal.show();
    }
    transformForm.addEventListener('submit',e=>{
      e.preventDefault(); e.stopPropagation();
      if(!transformForm.checkValidity()){ transformForm.classList.add('was-validated'); return; }
      const formato = document.getElementById('formatSelect').value;
      const reporte = reports.find(r=>r.id===selectedReportId);
      if(reporte){ reporte.formato=formato; reporte.estado='Transformado'; }
      renderReports(); showToast('Transformación exitosa.');
      transformModal.hide();
    });
    function deleteReport(id){
      reports = reports.filter(r=>r.id!==id);
      renderReports(); showToast('Reporte eliminado.');
    }

    // Render usuarios
    const usersTable = document.getElementById('usersTable');
    function renderUsers(){
      const filas = users.map(u=>`
        <tr>
          <td>${u.email}</td>
          <td><span class="badge ${u.rol==='admin'?'bg-danger':'bg-info text-dark'}">${u.rol}</span></td>
          <td>${u.activo?'Activo':'Inactivo'}</td>
        </tr>`);
      usersTable.innerHTML=`
        <thead><tr><th>Email</th><th>Rol</th><th>Estado</th></tr></thead>
        <tbody>${filas.join('')}</tbody>`;
    }

    // User modal
    const userModal = new bootstrap.Modal('#userModal');
    const userForm  = document.getElementById('userForm');
    function openUserModal(){
      userForm.reset(); userForm.classList.remove('was-validated');
      userModal.show();
    }
    userForm.addEventListener('submit',e=>{
      e.preventDefault(); e.stopPropagation();
      if(!userForm.checkValidity()){ userForm.classList.add('was-validated'); return; }
      const email = document.getElementById('userEmail').value.trim();
      const rol   = document.getElementById('userRole').value;
      if(users.some(u=>u.email===email)){ showToast('Email ya registrado.',false); return; }
      users.push({ id:Date.now(), email, rol, activo:true });
      renderUsers(); showToast('Usuario creado con éxito.');
      userModal.hide();
    });

    // Importar y parsear Excel
    document.getElementById('excelInput').addEventListener('change', async e=>{
      const file = e.target.files[0];
      if(!file) return;
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data);
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet,{header:1});
      let html = '<table class="table table-sm">';
      rows.forEach(r=>{
        html += '<tr>' + r.map(c=>`<td>${c||''}</td>`).join('') + '</tr>';
      });
      html += '</table>';
      document.getElementById('excelPreview').innerHTML = html;
      showToast(`Archivo parseado: ${rows.length} filas.`);
    });

    // Búsqueda de reportes
    document.getElementById('searchReports').addEventListener('input',e=>{
      renderReports(e.target.value);
    });

    // Navegación de pestañas
    const reportsSection = document.getElementById('reportsSection');
    const excelSection   = document.getElementById('excelSection');
    const usersSection   = document.getElementById('usersSection');
    document.getElementById('tabReports').onclick = ()=>{
      reportsSection.classList.remove('d-none');
      excelSection.classList.add('d-none');
      usersSection.classList.add('d-none');
      document.getElementById('tabReports').classList.add('active');
      document.getElementById('tabImport').classList.remove('active');
      document.getElementById('tabUsers').classList.remove('active');
    };
    document.getElementById('tabImport').onclick = ()=>{
      reportsSection.classList.add('d-none');
      excelSection.classList.remove('d-none');
      usersSection.classList.add('d-none');
      document.getElementById('tabImport').classList.add('active');
      document.getElementById('tabReports').classList.remove('active');
      document.getElementById('tabUsers').classList.remove('active');
    };
    document.getElementById('tabUsers').onclick = ()=>{
      reportsSection.classList.add('d-none');
      excelSection.classList.add('d-none');
      usersSection.classList.remove('d-none');
      document.getElementById('tabUsers').classList.add('active');
      document.getElementById('tabReports').classList.remove('active');
      document.getElementById('tabImport').classList.remove('active');
    };

    // Inicializar vistas
    renderReports();
    renderUsers();
  </script>
</body>
</html>
